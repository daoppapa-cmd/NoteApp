<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>កម្មវិធីកត់ត្រា - Modern Notes Premium</title>
    
    <!-- Google Fonts: Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Kantumruy Pro"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6366f1', // Indigo 500
                        secondary: '#ec4899', // Pink 500
                        danger: '#ef4444', 
                        success: '#10b981',
                        surface: '#ffffff',
                        background: '#f8fafc',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'bounce-subtle': 'bounceSubtle 0.3s ease-in-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.1)' },
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(99, 102, 241, 0.3)',
                        'nav': '0 -4px 20px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .note-card {
            background: white;
            border: 1px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .note-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(99, 102, 241, 0.15);
            border-color: #e0e7ff;
        }

        /* Nav Item Styles */
        .nav-item {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 20px;
            height: 3px;
            background: #6366f1;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }
        .nav-item.active {
            color: #6366f1;
        }
        .nav-item.active::after {
            transform: translateX(-50%) scaleX(1);
        }

        .nav-item-trash.active {
            color: #ef4444;
        }
        .nav-item-trash.active::after {
            background: #ef4444;
            transform: translateX(-50%) scaleX(1);
        }

        /* Mobile Nav Icon Animation */
        .mobile-nav-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        .mobile-nav-btn.active .icon-container {
            background-color: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
        .mobile-nav-btn.active-trash .icon-container {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row text-slate-700 bg-slate-50">

    <!-- DESKTOP SIDEBAR -->
    <aside class="hidden md:flex flex-col w-72 bg-white h-full z-20 border-r border-slate-200 shadow-sm">
        <div class="p-8 flex items-center gap-3">
            <div class="bg-primary text-white p-2.5 rounded-xl shadow-lg shadow-primary/30">
                <i data-lucide="notebook-pen" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">NoteApp</h1>
                <p class="text-[11px] text-slate-400 font-medium tracking-wider">PREMIUM</p>
            </div>
        </div>

        <div class="px-6 mb-6">
            <button onclick="openModal()" class="w-full bg-primary hover:bg-indigo-600 text-white py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex items-center justify-center gap-2 font-semibold group">
                <i data-lucide="plus" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300"></i>
                <span>បង្កើតថ្មី</span>
            </button>
        </div>

        <nav class="flex-1 px-4 space-y-1">
            <button onclick="filterNotes('all')" id="nav-all" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-slate-500 hover:bg-slate-50 rounded-xl font-medium">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span>ទាំងអស់</span>
            </button>
            <button onclick="filterNotes('favorite')" id="nav-fav" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-slate-500 hover:bg-slate-50 rounded-xl font-medium">
                <i data-lucide="heart" class="w-5 h-5"></i>
                <span>ដែលចូលចិត្ត</span>
            </button>
            
            <div class="pt-6 mt-2 border-t border-slate-100">
                <p class="px-4 text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider">ផ្សេងៗ</p>
                <button onclick="filterNotes('trash')" id="nav-trash" class="nav-item-trash nav-item w-full flex items-center gap-3 px-4 py-3.5 text-slate-500 hover:bg-red-50 hover:text-red-500 rounded-xl font-medium transition-colors">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                    <span>ធុងសំរាម</span>
                </button>
            </div>
        </nav>
        
        <div class="p-4 text-center">
            <div id="connectionStatus" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 text-xs font-medium border border-slate-200">
                <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                Connecting...
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/50">
        
        <!-- Mobile Header -->
        <header class="glass-panel sticky top-0 z-10 px-4 py-3 md:px-8 md:py-4 flex flex-col md:flex-row md:justify-between md:items-center border-b border-slate-200/60">
            <!-- Mobile Top Row -->
            <div class="md:hidden flex justify-between items-center mb-3">
                <div class="flex items-center gap-2.5">
                    <div class="bg-primary text-white p-1.5 rounded-lg shadow-sm">
                        <i data-lucide="notebook-pen" class="w-4 h-4"></i>
                    </div>
                    <h1 class="font-bold text-lg text-slate-800 tracking-tight">NoteApp</h1>
                </div>
                <div id="mobileConnectionStatus" class="w-2.5 h-2.5 rounded-full bg-slate-300"></div>
            </div>

            <!-- Search Bar (Full Width on Mobile) -->
            <div class="relative w-full md:w-96 ml-auto group">
                <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                    <i data-lucide="search" class="h-4 w-4 text-slate-400 group-focus-within:text-primary transition-colors"></i>
                </div>
                <input type="text" id="searchInput" onkeyup="searchNotes()" placeholder="ស្វែងរកកំណត់ត្រា..." 
                    class="block w-full pl-10 pr-10 py-3 md:py-2.5 border-none rounded-2xl bg-white shadow-sm focus:bg-white text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all">
                 <div id="loadingIndicator" class="absolute right-3 top-3 md:top-2.5 hidden">
                    <div class="w-4 h-4 border-2 border-primary/30 border-t-primary rounded-full animate-spin"></div>
                 </div>
            </div>
        </header>

        <!-- Trash Banner -->
        <div id="trashBanner" class="hidden bg-red-50 border-b border-red-100 px-4 py-2 text-center animate-fade-in z-0">
            <p class="text-xs text-red-600 font-medium flex items-center justify-center gap-2">
                <i data-lucide="clock" class="w-3.5 h-3.5"></i>
                <span>នឹងលុបស្វ័យប្រវត្តិក្នុងរយៈពេល 60 ថ្ងៃ</span>
            </p>
        </div>

        <!-- Notes Grid Area -->
        <div id="notesContainer" class="flex-1 overflow-y-auto p-4 md:p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 content-start pb-32 md:pb-8">
            <!-- Notes injected via JS -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none pb-20">
            <div class="relative">
                <div class="absolute inset-0 bg-primary/10 blur-2xl rounded-full transform scale-150"></div>
                <div class="bg-white p-6 rounded-3xl shadow-xl shadow-indigo-100/50 relative animate-float">
                    <i id="emptyIcon" data-lucide="file-plus-2" class="w-10 h-10 text-primary"></i>
                </div>
            </div>
            <h3 id="emptyText" class="mt-6 text-lg font-bold text-slate-700">ចាប់ផ្តើមថ្មី</h3>
            <p id="emptySubText" class="text-slate-400 mt-2 text-center text-sm max-w-[200px]">មិនទាន់មានកំណត់ត្រានៅឡើយទេ</p>
        </div>
    </main>

    <!-- MOBILE FLOATING ACTION BUTTON (Fixed to Body) -->
    <button id="mobileFab" onclick="openModal()" class="md:hidden fixed bottom-24 right-5 bg-primary text-white p-4 rounded-2xl shadow-lg shadow-indigo-500/30 z-50 active:scale-90 transition-all hover:bg-indigo-600 hover:-translate-y-1">
        <i data-lucide="plus" class="w-7 h-7 stroke-[2.5]"></i>
    </button>

    <!-- MOBILE BOTTOM NAVIGATION (Icon Only) -->
    <nav class="md:hidden fixed bottom-0 w-full glass-nav z-50 pb-safe shadow-nav rounded-t-2xl">
        <div class="flex justify-evenly items-center h-[72px]">
            <button onclick="filterNotes('all')" id="mob-nav-all" class="mobile-nav-btn w-16 h-full flex items-center justify-center group">
                <div class="icon-container p-2.5 rounded-2xl transition-all duration-300 text-slate-400 group-active:scale-95">
                    <i data-lucide="layout-grid" class="w-6 h-6 stroke-[2]"></i>
                </div>
            </button>
            
            <button onclick="filterNotes('favorite')" id="mob-nav-fav" class="mobile-nav-btn w-16 h-full flex items-center justify-center group">
                <div class="icon-container p-2.5 rounded-2xl transition-all duration-300 text-slate-400 group-active:scale-95">
                    <i data-lucide="heart" class="w-6 h-6 stroke-[2]"></i>
                </div>
            </button>
            
            <button onclick="filterNotes('trash')" id="mob-nav-trash" class="mobile-nav-btn w-16 h-full flex items-center justify-center group">
                <div class="icon-container p-2.5 rounded-2xl transition-all duration-300 text-slate-400 group-active:scale-95">
                    <i data-lucide="trash-2" class="w-6 h-6 stroke-[2]"></i>
                </div>
            </button>
        </div>
    </nav>

    <!-- Modal -->
    <div id="noteModal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center sm:items-center p-0 sm:p-4 text-center">
                <div id="modalPanel" class="relative transform overflow-hidden rounded-t-3xl sm:rounded-3xl bg-white text-left shadow-2xl transition-all w-full sm:max-w-2xl h-[90vh] sm:h-auto opacity-0 translate-y-full sm:translate-y-4 sm:scale-95 flex flex-col">
                    
                    <!-- Modal Header -->
                    <div class="bg-white px-6 py-4 border-b border-slate-50 flex justify-between items-center sticky top-0 z-10">
                        <div class="flex items-center gap-3">
                            <button onclick="closeModal()" class="md:hidden p-2 -ml-2 rounded-full hover:bg-slate-100 text-slate-500">
                                <i data-lucide="chevron-down" class="w-6 h-6"></i>
                            </button>
                            <span id="modalTitle" class="text-lg font-bold text-slate-800">បង្កើតថ្មី</span>
                        </div>
                        <div class="flex gap-1">
                            <button id="favoriteBtn" onclick="toggleFavoriteInModal()" class="p-2.5 rounded-xl hover:bg-pink-50 text-slate-400 transition-colors">
                                <i data-lucide="heart" class="w-5 h-5"></i>
                            </button>
                            <button onclick="closeModal()" class="hidden md:block p-2.5 rounded-xl hover:bg-slate-100 text-slate-500 transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="px-6 py-6 flex-1 overflow-y-auto">
                        <input type="hidden" id="noteId">
                        <input type="text" id="inputTitle" placeholder="ចំណងជើង..." class="w-full text-2xl font-bold text-slate-800 placeholder:text-slate-300 bg-transparent border-none outline-none mb-4">
                        <div class="h-px bg-slate-100 w-full mb-6"></div>
                        <textarea id="inputContent" placeholder="សរសេរអ្វីដែលសំខាន់នៅទីនេះ..." class="w-full h-full min-h-[300px] resize-none text-slate-600 leading-relaxed placeholder:text-slate-300 bg-transparent border-none outline-none text-lg"></textarea>
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-white px-6 py-4 border-t border-slate-50 flex justify-end gap-3 pb-safe">
                        <button onclick="closeModal()" class="hidden md:block px-5 py-3 rounded-xl text-slate-500 font-medium hover:bg-slate-50 transition-colors">បោះបង់</button>
                        <button onclick="saveNote()" id="saveBtn" class="w-full md:w-auto px-6 py-3 rounded-xl bg-primary hover:bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                            <span>រក្សាទុក</span>
                            <i data-lucide="check" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl transform -translate-y-32 transition-all duration-300 z-[70] flex items-center gap-3 w-auto max-w-[90%] whitespace-nowrap">
        <div class="bg-green-500 rounded-full p-1">
            <i data-lucide="check" class="w-3 h-3 text-white stroke-[3]"></i>
        </div>
        <span id="toastMessage" class="text-sm font-medium">ជោគជ័យ</span>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let notes = [];
        const SIXTY_DAYS_MS = 60 * 24 * 60 * 60 * 1000; 

        // Auth
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth:", error);
                updateConnectionStatus(false);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateConnectionStatus(true);
                subscribeToNotes();
            } else {
                currentUser = null;
                updateConnectionStatus(false);
                notes = [];
                renderNotes();
            }
        });

        function updateConnectionStatus(isOnline) {
            const el = document.getElementById('connectionStatus');
            const mobEl = document.getElementById('mobileConnectionStatus');
            
            if(isOnline) {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online';
                el.className = "inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 text-green-700 text-xs font-medium border border-green-100";
                if(mobEl) mobEl.className = "w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
            } else {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Offline';
                el.className = "inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-50 text-red-700 text-xs font-medium border border-red-100";
                if(mobEl) mobEl.className = "w-2.5 h-2.5 rounded-full bg-red-500";
            }
        }

        // Data Sync
        function subscribeToNotes() {
            if (!currentUser) return;
            const q = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notes');
            document.getElementById('loadingIndicator').classList.remove('hidden');

            onSnapshot(q, (snapshot) => {
                notes = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.deletedAt) {
                         const deletedTime = data.deletedAt.toDate ? data.deletedAt.toDate().getTime() : (new Date(data.deletedAt).getTime());
                         if (Date.now() - deletedTime > SIXTY_DAYS_MS) {
                             deleteDoc(doc.ref).catch(console.error);
                             return; 
                         }
                    }
                    notes.push({ id: doc.id, ...data });
                });
                
                notes.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : (a.timestamp || 0);
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : (b.timestamp || 0);
                    return timeB - timeA;
                });

                document.getElementById('loadingIndicator').classList.add('hidden');
                renderNotes();
            });
        }

        // Functions exposed to Window
        window.saveNote = async function() {
            if (!currentUser) return showToast("សូមភ្ជាប់អ៊ិនធឺណិត", "error");
            const id = document.getElementById('noteId').value;
            const title = document.getElementById('inputTitle').value.trim();
            const content = document.getElementById('inputContent').value.trim();

            if (!title && !content) { window.closeModal(); return; }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>';

            try {
                const noteData = {
                    title, content,
                    isFavorite: window.isFavoriteModal,
                    timestamp: serverTimestamp()
                };

                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', id), noteData);
                    showToast('កែប្រែជោគជ័យ');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notes'), noteData);
                    showToast('បង្កើតជោគជ័យ');
                }
                window.closeModal();
            } catch (error) {
                console.error(error);
                showToast("មានបញ្ហា", "error");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span>រក្សាទុក</span><i data-lucide="check" class="w-5 h-5"></i>';
                lucide.createIcons();
            }
        }

        window.deleteNote = async function(id) {
            if(!currentUser) return;
            if(confirm('ដាក់ចូលធុងសំរាម?')) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', id), {
                        deletedAt: serverTimestamp(),
                        isFavorite: false
                    });
                    showToast('បានដាក់ចូលធុងសំរាម');
                } catch (e) { console.error(e); }
            }
        }

        window.restoreNote = async function(id) {
            if(!currentUser) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', id), {
                    deletedAt: deleteField()
                });
                showToast('បានស្តារវិញ');
            } catch (e) { console.error(e); }
        }

        window.permanentDelete = async function(id) {
            if(!currentUser) return;
            if(confirm('លុបចោលជាអចិន្ត្រៃយ៍? មិនអាចយកវិញបានទេ។')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', id));
                    showToast('បានលុបជាអចិន្ត្រៃយ៍');
                } catch (e) { console.error(e); }
            }
        }

        window.toggleFavorite = async function(id) {
            const note = notes.find(n => n.id === id);
            if (note && !note.deletedAt) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', id), { 
                        isFavorite: !note.isFavorite 
                    });
                } catch (e) { console.error(e); }
            }
        }

        // Rendering
        window.isFavoriteModal = false;
        let currentFilter = 'all';

        window.renderNotes = function() {
            const container = document.getElementById('notesContainer');
            const emptyState = document.getElementById('emptyState');
            const trashBanner = document.getElementById('trashBanner');
            const mobileFab = document.getElementById('mobileFab');
            
            container.innerHTML = '';
            
            // Filter logic
            let filtered = notes.filter(n => {
                if(currentFilter === 'trash') return !!n.deletedAt;
                return !n.deletedAt;
            });

            // Tab specific UI
            if (currentFilter === 'trash') {
                trashBanner.classList.remove('hidden');
                mobileFab.classList.add('hidden');
                document.getElementById('emptyText').textContent = "ធុងសំរាមទទេ";
                document.getElementById('emptySubText').textContent = "គ្មានឯកសារដែលបានលុប";
                document.getElementById('emptyIcon').setAttribute('data-lucide', 'trash-2');
                document.getElementById('emptyIcon').classList.add('text-red-400');
                document.getElementById('emptyIcon').classList.remove('text-primary');
            } else {
                trashBanner.classList.add('hidden');
                mobileFab.classList.remove('hidden');
                document.getElementById('emptyText').textContent = "ចាប់ផ្តើមថ្មី";
                document.getElementById('emptySubText').textContent = "ចុចប៊ូតុង + ដើម្បីបង្កើតកំណត់ត្រា";
                document.getElementById('emptyIcon').setAttribute('data-lucide', 'file-plus-2');
                document.getElementById('emptyIcon').classList.remove('text-red-400');
                document.getElementById('emptyIcon').classList.add('text-primary');
            }

            // Search
            const term = document.getElementById('searchInput').value.toLowerCase();
            if(term) {
                filtered = filtered.filter(n => (n.title||'').toLowerCase().includes(term) || (n.content||'').toLowerCase().includes(term));
            }

            // Favorites
            if(currentFilter === 'favorite') {
                filtered = filtered.filter(n => n.isFavorite);
                window.updateNavActiveState('nav-fav');
            } else if (currentFilter === 'trash') {
                window.updateNavActiveState('nav-trash');
            } else {
                window.updateNavActiveState('nav-all');
            }

            // Render
            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filtered.forEach((note, i) => {
                    let dateStr = "ឥឡូវនេះ";
                    if(note.timestamp) {
                        const d = note.timestamp.toDate ? note.timestamp.toDate() : new Date(note.timestamp);
                        dateStr = d.toLocaleDateString('km-KH', { day: 'numeric', month: 'short', year: 'numeric' });
                    }

                    const card = document.createElement('div');
                    card.className = `note-card p-5 rounded-3xl flex flex-col gap-3 h-56 relative group animate-slide-up select-none`;
                    card.style.animationDelay = `${i * 0.05}s`;

                    // Card Header
                    let headerHtml = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-[17px] text-slate-800 line-clamp-1 pr-2 tracking-tight">${note.title || 'គ្មានចំណងជើង'}</h3>
                             ${currentFilter !== 'trash' ? `
                                <button onclick="event.stopPropagation(); toggleFavorite('${note.id}')" class="p-2 -mr-2 -mt-2 rounded-full active:scale-90 transition-all ${note.isFavorite ? 'text-secondary' : 'text-slate-300'}">
                                    <i data-lucide="heart" class="w-5 h-5 ${note.isFavorite ? 'fill-current' : ''}"></i>
                                </button>
                             ` : `<span class="px-2 py-0.5 bg-red-50 text-red-500 text-[10px] rounded-md font-bold">DELETED</span>`}
                        </div>
                    `;

                    // Card Content
                    let contentHtml = `
                        <p class="text-slate-500 text-[15px] line-clamp-3 leading-relaxed flex-1">${note.content || ''}</p>
                    `;

                    // Card Footer (Actions)
                    let actionsHtml = '';
                    if (currentFilter === 'trash') {
                        // TRASH VIEW ACTIONS: Two Big Buttons
                        actionsHtml = `
                            <div class="grid grid-cols-2 gap-3 mt-auto pt-3 border-t border-slate-50">
                                <button onclick="event.stopPropagation(); restoreNote('${note.id}')" class="flex items-center justify-center gap-1.5 py-2.5 rounded-xl bg-green-50 text-green-600 active:bg-green-100 transition-colors text-xs font-bold">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> ស្តារ
                                </button>
                                <button onclick="event.stopPropagation(); permanentDelete('${note.id}')" class="flex items-center justify-center gap-1.5 py-2.5 rounded-xl bg-red-50 text-red-600 active:bg-red-100 transition-colors text-xs font-bold">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i> លុប
                                </button>
                            </div>
                        `;
                        card.onclick = null;
                    } else {
                        // NORMAL VIEW ACTIONS
                        actionsHtml = `
                            <div class="flex justify-between items-center pt-3 border-t border-slate-50 mt-auto">
                                <span class="text-[11px] font-semibold text-slate-400 tracking-wide">${dateStr}</span>
                                <button onclick="event.stopPropagation(); deleteNote('${note.id}')" class="p-2 -mr-2 rounded-xl text-slate-300 hover:text-red-500 active:bg-red-50 transition-all opacity-100 md:opacity-0 group-hover:opacity-100">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                        card.onclick = (e) => {
                            if(e.target.closest('button')) return;
                            window.openModal(note.id);
                        }
                        card.style.cursor = 'pointer';
                    }

                    card.innerHTML = headerHtml + contentHtml + actionsHtml;
                    container.appendChild(card);
                });
                lucide.createIcons();
            }
        }

        // Navigation UI
        window.updateNavActiveState = function(activeId) {
            // Reset all
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active', 'active-trash'));

            // Desktop
            const dBtn = document.getElementById(activeId);
            if(dBtn) dBtn.classList.add('active');

            // Mobile
            const map = { 'nav-all': 'mob-nav-all', 'nav-fav': 'mob-nav-fav', 'nav-trash': 'mob-nav-trash' };
            const mBtn = document.getElementById(map[activeId]);
            if(mBtn) {
                if(activeId === 'nav-trash') mBtn.classList.add('active-trash');
                else mBtn.classList.add('active');
            }
        }

        // Modal Logic
        window.openModal = function(noteId = null) {
            if(currentFilter === 'trash') return;
            const modal = document.getElementById('noteModal');
            const backdrop = document.getElementById('modalBackdrop');
            const panel = document.getElementById('modalPanel');

            document.getElementById('noteId').value = '';
            document.getElementById('inputTitle').value = '';
            document.getElementById('inputContent').value = '';
            window.isFavoriteModal = false;

            if (noteId) {
                const note = notes.find(n => n.id === noteId);
                if(note) {
                    document.getElementById('noteId').value = note.id;
                    document.getElementById('inputTitle').value = note.title;
                    document.getElementById('inputContent').value = note.content;
                    document.getElementById('modalTitle').innerText = 'កែប្រែកំណត់ត្រា';
                    window.isFavoriteModal = note.isFavorite;
                }
            } else {
                document.getElementById('modalTitle').innerText = 'បង្កើតថ្មី';
            }
            updateFavoriteModalUI();

            modal.classList.remove('hidden');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                if(window.innerWidth < 768) {
                    // Mobile animation: Slide up from bottom
                    panel.classList.remove('translate-y-full', 'opacity-0'); 
                } else {
                    // Desktop animation: Fade/Scale in
                    panel.classList.remove('opacity-0', 'scale-95', 'translate-y-4');
                    panel.classList.add('scale-100', 'translate-y-0');
                }
            }, 10);
        }

        window.closeModal = function() {
            const modal = document.getElementById('noteModal');
            const backdrop = document.getElementById('modalBackdrop');
            const panel = document.getElementById('modalPanel');

            backdrop.classList.add('opacity-0');
            if(window.innerWidth < 768) {
                 panel.classList.add('translate-y-full', 'opacity-0');
            } else {
                 panel.classList.add('opacity-0', 'scale-95', 'translate-y-4');
                 panel.classList.remove('scale-100', 'translate-y-0');
            }
            
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        window.toggleFavoriteInModal = function() {
            window.isFavoriteModal = !window.isFavoriteModal;
            updateFavoriteModalUI();
        }

        window.updateFavoriteModalUI = function() {
            const btn = document.getElementById('favoriteBtn');
            const i = btn.querySelector('svg') || btn.querySelector('i');
            if(window.isFavoriteModal) {
                btn.classList.add('text-secondary', 'bg-pink-50');
                btn.classList.remove('text-slate-400');
                if(i) i.classList.add('fill-current');
            } else {
                btn.classList.remove('text-secondary', 'bg-pink-50');
                btn.classList.add('text-slate-400');
                if(i) i.classList.remove('fill-current');
            }
        }

        window.showToast = function(msg, type="success") {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            t.classList.remove('-translate-y-32');
            t.classList.add('translate-y-4');
            setTimeout(() => {
                t.classList.remove('translate-y-4');
                t.classList.add('-translate-y-32');
            }, 3000);
        }

        window.searchNotes = function() { renderNotes(); }
        window.filterNotes = function(t) { currentFilter = t; renderNotes(); }

        document.getElementById('noteModal').addEventListener('click', (e) => {
            if(e.target.id === 'modalBackdrop') window.closeModal();
        });

        lucide.createIcons();
    </script>
</body>
</html>
